from datetime import datetime
from tqdm import tqdm
from pydrive.auth import GoogleAuth
from pydrive.drive import GoogleDrive
import requests
import io
import json

from random import randrange

import vk_api
from vk_api.longpoll import VkLongPoll, VkEventType


"""
Токены
"""
with open('token.txt') as file_object:
    TOKEN_GROUP = file_object.readline().strip()
    TOKEN_APP = file_object.readline().strip()


class BotVK:
    def __init__(self):
        self.vk = vk_api.VkApi(token=TOKEN_GROUP)
        self.longpoll = VkLongPoll(self.vk)
        self.url = 'https://api.vk.com/method/'

    def write_msg(self, user_id, message):
        self.vk.method('messages.send', {'user_id': user_id,
                                         'message': message,
                                         'random_id': randrange(10 ** 7)})

    def name_user(self, user_id):
        url_name = self.url + 'users.get'
        params = {'access_token': TOKEN_GROUP,
                  'user_ids': user_id,
                  'v': '5.131'}
        repl = requests.get(url_name, params=params)
        response = repl.json()
        try:
            information_dict = response['response']
            for i in information_dict:
                for key, value in i.items():
                    first_name = i.get('first_name')
                    return first_name
        except KeyError:
            self.write_msg(user_id, 'Ошибка получения токена, введите токен в переменную - user_token')




bot = BotVK()
for event in bot.longpoll.listen():
    if event.type == VkEventType.MESSAGE_NEW and event.to_me:
        request = event.text.lower()
        user_id = str(event.user_id)
        msg = event.text.lower()
        if request == 'начать поиск':
            bot.write_msg(user_id, f'Привет, {bot.name_user(user_id)}')
            bot.write_msg(event.user_id, f'Нашёл для тебя пару, жми на кнопку "Вперёд"')

        else:
            bot.write_msg(event.user_id, 'Твоё сообщение непонятно')
